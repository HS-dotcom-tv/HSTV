<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HSTV - جداول المباريات</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg,#0f172a,#1e293b); min-height:100vh; color:#fff; }
    .match-card { transition: all .2s; backdrop-filter: blur(6px); }
    .match-card:hover { transform: translateY(-4px); background: rgba(30,41,59,0.75); }
    .team-name { max-width: 120px; display:inline-block; vertical-align: middle; text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }
    .score-box { min-width: 90px; display:flex; align-items:center; justify-content:center; text-align:center; }
    .btn-tab.active { background: linear-gradient(90deg,#10b981,#06b6d4); color:#042; font-weight:700; }
    .crest { width:34px; height:34px; object-fit:contain; border-radius:6px; }
  </style>
</head>
<body class="p-4">

  <header class="text-center mb-6">
    <h1 class="text-4xl font-bold" style="background:linear-gradient(45deg,#10b981,#06b6d4); -webkit-background-clip:text; color:transparent">HSTV</h1>
    <p class="text-slate-400 mt-1">أحدث المباريات — مصنفة حسب الأهمية</p>
  </header>

  <div class="max-w-3xl mx-auto mb-6">
    <div class="flex gap-3">
      <button id="yesterday" class="btn-tab flex-1 px-4 py-2 rounded-xl bg-slate-700">الأمس</button>
      <button id="today" class="btn-tab flex-1 px-4 py-2 rounded-xl btn-tab active">اليوم</button>
      <button id="tomorrow" class="btn-tab flex-1 px-4 py-2 rounded-xl bg-slate-700">الغد</button>
    </div>
  </div>

  <main id="matches" class="max-w-3xl mx-auto space-y-4"></main>

  <script>
    const API_URL = 'matches.json';
    const matchesContainer = document.getElementById('matches');

    // قوائم التحكم: دوريات نعرضها (رموز football-data.org) — يمكنك تعديلها بسهولة
    const ALLOWED_COMPETITIONS = new Set([
      'CL','PL','PD','SA','BL1','FL1','WC','EC','AFCON','UEFA EURO','EL' // CL, Prem, LaLiga, SerieA, Bundesliga, Ligue1, WorldCup, Euros, AFCON, Europa League (EL)
    ]);
    // فرق عربية مهمة (نص من الاسم يكفي)
    const SPECIAL_ARAB_TEAMS = ['Al Hilal','Al Nassr','Al Ittihad','Al Ahly','Zamalek','Raja','Wydad','Esperance','Alger','USM','WAC','TER'];


    function setActiveTab(id) {
      document.querySelectorAll('.btn-tab').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    function getDateString(offset = 0) {
      const d = new Date();
      d.setDate(d.getDate() + offset);
      return d.toISOString().split('T')[0];
    }

    function isImportantCompetition(league) {
      // league.code is preferred; fallback to league.name
      if (!league) return false;
      const code = (league.code || '').toString();
      const name = (league.name || '').toLowerCase();
      if (code && ALLOWED_COMPETITIONS.has(code)) return true;
      // check major words
      if (name.includes('champions') || name.includes('premier') || name.includes('la liga') || name.includes('serie') || name.includes('bundesliga') || name.includes('world') || name.includes('europe') || name.includes('africa')) return true;
      return false;
    }

    function includeSpecialTeam(match) {
      const home = (match.teams.home.name || '').toLowerCase();
      const away = (match.teams.away.name || '').toLowerCase();
      return SPECIAL_ARAB_TEAMS.some(s => home.includes(s.toLowerCase()) || away.includes(s.toLowerCase()));
    }

    function formatTime(iso) {
      try {
        const d = new Date(iso);
        return d.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Riyadh' });
      } catch (e) { return iso; }
    }

    async function loadMatches(view='today') {
      setActiveTab(view);
      matchesContainer.innerHTML = `<div class="text-center py-12 text-slate-400">جاري تحميل المباريات...</div>`;
      try {
        const res = await fetch(API_URL + '?t=' + Date.now());
        if (!res.ok) throw new Error('network ' + res.status);
        const data = await res.json();
        const all = data.response || [];
        renderMatches(all, view, data.generated_at);
      } catch (err) {
        console.error(err);
        matchesContainer.innerHTML = `<div class="text-center py-12 text-red-400">فشل تحميل البيانات — ${err.message}</div>`;
      }
    }

    function renderMatches(allMatches, view, generatedAt) {
      matchesContainer.innerHTML = '';
      const offset = view === 'yesterday' ? -1 : view === 'tomorrow' ? 1 : 0;
      const target = getDateString(offset);

      // filter: only important competitions OR special teams
      let filtered = allMatches.filter(m => {
        if (!m || !m.fixture || !m.fixture.date) return false;
        if (!m.fixture.date.startsWith(target)) return false;
        // Important league?
        if (isImportantCompetition(m.league)) return true;
        // special arab teams
        if (includeSpecialTeam(m)) return true;
        // otherwise ignore
        return false;
      });

      // sort by league importance (isImportantCompetition first) then time
      filtered.sort((a,b) => {
        const aImp = isImportantCompetition(a.league) ? 0 : 1;
        const bImp = isImportantCompetition(b.league) ? 0 : 1;
        if (aImp !== bImp) return aImp - bImp;
        return new Date(a.fixture.date) - new Date(b.fixture.date);
      });

      // header debug
      const header = document.createElement('div');
      header.className = 'text-slate-400 text-sm mb-2 text-center';
      header.innerHTML = `عرض ${filtered.length} مباراة — ${target} ${generatedAt ? ' · آخر تحديث: ' + new Date(generatedAt).toLocaleString() : ''}`;
      matchesContainer.appendChild(header);

      if (!filtered.length) {
        matchesContainer.innerHTML += `<div class="text-center py-12 text-slate-400">⚽ لا توجد مباريات في هذا اليوم</div>`;
        return;
      }

      // group by competition (preserve order)
      const groups = [];
      const map = new Map();
      for (const m of filtered) {
        const lid = (m.league && (m.league.code || m.league.id || m.league.name)) || 'unknown';
        if (!map.has(lid)) {
          map.set(lid, { info: m.league, matches: [] });
          groups.push(lid);
        }
        map.get(lid).matches.push(m);
      }

      for (const gid of groups) {
        const grp = map.get(gid);
        const box = document.createElement('div');
        box.className = 'bg-slate-800/30 rounded-2xl overflow-hidden mb-4';
        box.innerHTML = `
          <div class="px-4 py-3 flex items-center gap-3 bg-gradient-to-r from-slate-900 to-slate-800">
            ${grp.info && grp.info.logo ? `<img class="crest" src="${grp.info.logo}" alt="" onerror="this.style.display='none'">` : ''}
            <div>
              <div class="font-bold">${grp.info.name || ''}</div>
              <div class="text-slate-400 text-xs">${grp.info.country || ''}</div>
            </div>
          </div>
        `;
        // sort matches by time
        grp.matches.sort((a,b)=> new Date(a.fixture.date) - new Date(b.fixture.date));
        for (const match of grp.matches) {
          const el = document.createElement('div');
          el.className = 'match-card border-t border-slate-700/40';
          el.innerHTML = renderMatchHTML(match);
          box.appendChild(el);
        }
        matchesContainer.appendChild(box);
      }
    }

    function renderMatchHTML(match) {
      const timeStr = formatTime(match.fixture.date);
      const status = (match.fixture.status && match.fixture.status.short) || 'NS';
      // determine display for status/time/score
      let centerHtml = '';
      // if live or in-play
      if (["1H","2H","HT"].includes(status)) {
        centerHtml = `<div class="score-box">
          <div class="text-emerald-400 font-bold text-xl">${match.goals.home || 0} - ${match.goals.away || 0}</div>
        </div>`;
      } else if (["FT","AET","PEN"].includes(status)) {
        centerHtml = `<div class="score-box"><div class="font-bold">${match.goals.home || 0} - ${match.goals.away || 0}</div><div class="text-xs text-slate-400">انتهت</div></div>`;
      } else {
        // scheduled / timed / NS -> show time
        centerHtml = `<div class="score-box"><div class="text-lg font-bold">${timeStr}</div></div>`;
      }

      const homeLogo = match.teams.home.logo || '';
      const awayLogo = match.teams.away.logo || '';

      // short/truncate team names but show full on title
      const homeName = escapeHtml(match.teams.home.name || '');
      const awayName = escapeHtml(match.teams.away.name || '');

      return `
        <div class="p-4 flex items-center gap-3">
          <div class="flex-1 flex items-center justify-end gap-3 text-right">
            ${homeLogo ? `<img src="${homeLogo}" class="crest" alt="" onerror="this.style.display='none'">` : ''}
            <div class="team-name" title="${homeName}">${homeName}</div>
          </div>
          ${centerHtml}
          <div class="flex-1 flex items-center gap-3">
            ${awayLogo ? `<img src="${awayLogo}" class="crest" alt="" onerror="this.style.display='none'">` : ''}
            <div class="team-name" title="${awayName}">${awayName}</div>
          </div>
        </div>
      `;
    }

    // small helper to avoid XSS
    function escapeHtml(s='') {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // events
    document.getElementById('yesterday').addEventListener('click', ()=> { setActiveTab('yesterday'); loadMatches('yesterday'); });
    document.getElementById('today').addEventListener('click', ()=> { setActiveTab('today'); loadMatches('today'); });
    document.getElementById('tomorrow').addEventListener('click', ()=> { setActiveTab('tomorrow'); loadMatches('tomorrow'); });

    // initial
    loadMatches('today');

    // live refresh every 60s only when on 'today'
    setInterval(()=>{ if (document.getElementById('today').classList.contains('active')) loadMatches('today'); }, 60000);
  </script>
</body>
</html>
